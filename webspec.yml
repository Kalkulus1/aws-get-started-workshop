version: 0.2

phases:
  install:
    runtime-versions:
      docker: 19
      python: 3.7
      ruby: 2.7
  pre_build:
    commands:
      - locale-gen en_US en_US.UTF-8
      - dpkg-reconfigure locales
      - export LC_ALL="en_US.UTF-8"
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
      - |
        if [ ! -d ".git" ]; then
          echo Initializing Git Repo
          git init
          git remote add origin $FULL_REPO_URL
          git fetch
          git checkout -f "$CODEBUILD_RESOLVED_SOURCE_VERSION"
        fi
      - git submodule init
      - git submodule update --recursive --remote --merge
      - echo Install Hugo
      # Use known tested version of Hugo
      - curl -s https://api.github.com/repos/gohugoio/hugo/releases/latest | grep "download_url.*Linux-64bit.tar.gz" | grep -v "extended" | cut -d '"' -f 4 | wget -qi -
      - HUGO_TAR="$(find . -name "*Linux-64bit.tar.gz")"
      - tar -xzf $HUGO_TAR
      - chmod +x hugo
      - gem install html-proofer
      # Copy deployment script so that build stage can access it
      - cp automation/content-build-deploy/deploy.sh /usr/local/bin/
      # Set additional custom build environment variables
      - export CUSTOM_CODEBUILD_GIT_BRANCH="$(git symbolic-ref HEAD --short 2>/dev/null)"
      - if [ "$CUSTOM_CODEBUILD_GIT_BRANCH" = "" ] ; then
          CUSTOM_CODEBUILD_GIT_BRANCH="$(git branch -a --contains HEAD | sed -n 2p | awk '{ printf $1 }')";
          export CUSTOM_CODEBUILD_GIT_BRANCH=${CUSTOM_CODEBUILD_GIT_BRANCH#remotes/origin/};
        fi
      - export CUSTOM_CODEBUILD_PR=''
      - if [ "${CUSTOM_CODEBUILD_GIT_BRANCH#pr-}" != "$CUSTOM_CODEBUILD_GIT_BRANCH" ] ; then
          export CUSTOM_CODEBUILD_PR=${CUSTOM_CODEBUILD_GIT_BRANCH#pr-};
        fi
      - export CUSTOM_CODEBUILD_GIT_CLEAN_BRANCH="$(echo $CUSTOM_CODEBUILD_GIT_BRANCH | tr '/' '.')"
      - echo CUSTOM_CODEBUILD_GIT_BRANCH = ${CUSTOM_CODEBUILD_GIT_BRANCH}
      - echo CUSTOM_CODEBUILD_GIT_CLEAN_BRANCH = ${CUSTOM_CODEBUILD_GIT_CLEAN_BRANCH}
      - echo CUSTOM_CODEBUILD_PR = ${CUSTOM_CODEBUILD_PR}
      #- automation/content-build-deploy/build-env.sh

  build:
    commands:
      - echo Build website
      - ./hugo -D
      - HTML_PROOFER="$(gem contents html-proofer | grep '/bin/')"
      - echo running html-proofer
      - $HTML_PROOFER  ./public --check-html --empty-alt-ignore --allow-hash-href
      # fail if proofer has issues... if you want to deploy anyway, move these back to post_build
      - echo CUSTOM_CODEBUILD_GIT_CLEAN_BRANCH = ${CUSTOM_CODEBUILD_GIT_CLEAN_BRANCH}
      - deploy.sh
      - echo Deploy website static content to S3 Bucket
      - aws s3 cp public/ s3://${WEB_SITE_BUCKET}/ --recursive
      - aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRO_ID} --paths /\*
